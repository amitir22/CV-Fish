<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>CV-Fish Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="p-4">
    <h1 class="mb-4">CV-Fish Live Metrics</h1>
    <div class="row">
      <div class="col-md-8">
        <select id="metricSelect" class="form-select mb-2"></select>
        <canvas id="metricChart"></canvas>
      </div>
      <div class="col-md-4">
        <img id="latestFrame" class="img-fluid" alt="Latest frame" />
      </div>
    </div>

    <script>
    const numStd = 2;
    const metricSelect = document.getElementById('metricSelect');
    let selectedMetric = null;
    const ctx = document.getElementById('metricChart').getContext('2d');
    const data = {
      labels: [],
      datasets: [
        {label: '', data: [], borderColor: 'blue', fill: false},
        {label: 'Upper', data: [], borderColor: 'rgba(0,0,255,0.3)', fill: false},
        {label: 'Lower', data: [], borderColor: 'rgba(0,0,255,0.3)', fill: false}
      ]
    };
    const chart = new Chart(ctx, {
      type: 'line',
      data,
      options: {animation: false, plugins: {title: {display: true, text: ''}}}
    });

    metricSelect.addEventListener('change', () => {
      selectedMetric = metricSelect.value;
      fetchMetrics();
    });

    async function fetchMetrics() {
      const res = await fetch('/metrics');
      const json = await res.json();
      const rows = json.metrics;
      const unique = Array.from(new Set(rows.map(r => `${r.pair}_${r.metric_name}`)));
      if (!selectedMetric) {
        selectedMetric = unique[0];
        unique.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name.replace('_', ' ');
          metricSelect.appendChild(opt);
        });
        metricSelect.value = selectedMetric;
      }
      const filtered = rows.filter(r => `${r.pair}_${r.metric_name}` === selectedMetric);
      if (filtered.length === 0) return;
      const label = selectedMetric.replace('_', ' ');
      data.labels = filtered.map(r => r.time);
      const values = filtered.map(r => parseFloat(r.magnitude_mean));
      const stds = filtered.map(r => parseFloat(r.magnitude_deviation));
      data.datasets[0].label = label;
      chart.options.plugins.title.text = label;
      data.datasets[0].data = values;
      data.datasets[1].data = values.map((v, i) => v + numStd * stds[i]);
      data.datasets[2].data = values.map((v, i) => v - numStd * stds[i]);
      chart.update();
    }

    async function fetchFrame() {
      const img = document.getElementById('latestFrame');
      img.src = '/frame?' + Date.now();
    }

    fetchMetrics();
    fetchFrame();
    setInterval(fetchMetrics, 5000);
    setInterval(fetchFrame, 5000);
    </script>
  </body>
</html>
