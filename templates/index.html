<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>CV-Fish Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="p-4">
    <h1 class="mb-4">CV-Fish Live Metrics</h1>
    <div class="row">
      <div class="col-md-8">
        <canvas id="metricChart"></canvas>
      </div>
      <div class="col-md-4">
        <img id="latestFrame" class="img-fluid" alt="Latest frame" />
      </div>
    </div>

    <script>
    const numStd = 2;
    const ctx = document.getElementById('metricChart').getContext('2d');
    const data = {
      labels: [],
      datasets: [
        {label: 'Magnitude', data: [], borderColor: 'blue', fill: false},
        {label: 'Upper', data: [], borderColor: 'rgba(0,0,255,0.3)', fill: false},
        {label: 'Lower', data: [], borderColor: 'rgba(0,0,255,0.3)', fill: false}
      ]
    };
    const chart = new Chart(ctx, {type: 'line', data, options: {animation: false}});

    async function fetchMetrics() {
      const res = await fetch('/metrics');
      const json = await res.json();
      const rows = json.metrics.filter(m => m.metric_name === '1-2_Farneback');
      data.labels = rows.map(r => r.time);
      const values = rows.map(r => parseFloat(r.magnitude_mean));
      const stds = rows.map(r => parseFloat(r.magnitude_deviation));
      data.datasets[0].data = values;
      data.datasets[1].data = values.map((v, i) => v + numStd * stds[i]);
      data.datasets[2].data = values.map((v, i) => v - numStd * stds[i]);
      chart.update();
    }

    async function fetchFrame() {
      const img = document.getElementById('latestFrame');
      img.src = '/frame?' + Date.now();
    }

    fetchMetrics();
    fetchFrame();
    setInterval(fetchMetrics, 5000);
    setInterval(fetchFrame, 5000);
    </script>
  </body>
</html>
