<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>CV-Fish Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="p-4">
    <h1 class="mb-4">CV-Fish Live Metrics</h1>
    <div class="row">
      <div class="col-md-8">
        <select id="metricSelect" class="form-select mb-2"></select>
        <canvas id="metricChart"></canvas>
      </div>
      <div class="col-md-4">
        <img id="latestFrame" class="img-fluid mb-2" alt="Latest frame" />
        <div id="frameWindow" class="d-flex flex-column"></div>
      </div>
    </div>

    <script>
    const numStd = 2;
    const metricSelect = document.getElementById('metricSelect');
    let selectedMetric = null;
    const ctx = document.getElementById('metricChart').getContext('2d');
    const data = {
      labels: [],
      datasets: [
        {label: '', data: [], borderColor: 'blue', fill: false, pointRadius: 3},
        {label: 'Upper', data: [], borderColor: 'rgba(0,0,255,0.3)', fill: false, pointRadius: 0},
        {label: 'Lower', data: [], borderColor: 'rgba(0,0,255,0.3)', fill: false, pointRadius: 0}
      ]
    };
    const chart = new Chart(ctx, {
      type: 'line',
      data,
      options: {animation: false, plugins: {title: {display: true, text: ''}}}
    });
    const frameWindow = document.getElementById('frameWindow');
    let hoverTs = null;

    metricSelect.addEventListener('change', () => {
      selectedMetric = metricSelect.value;
      fetchMetrics();
    });

    async function fetchMetrics() {
      const res = await fetch('/metrics');
      const json = await res.json();
      const rows = json.metrics;
      const unique = Array.from(new Set(rows.map(r => `${r.pair}_${r.metric_name}`)));
      if (!selectedMetric) {
        selectedMetric = unique[0];
        unique.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name.replace('_', ' ');
          metricSelect.appendChild(opt);
        });
        metricSelect.value = selectedMetric;
      }
      const filtered = rows.filter(r => `${r.pair}_${r.metric_name}` === selectedMetric);
      if (filtered.length === 0) return;
      const label = selectedMetric.replace('_', ' ');
      data.labels = filtered.map(r => r.time);
      const values = filtered.map(r => parseFloat(r.magnitude_mean));
      const stds = filtered.map(r => parseFloat(r.magnitude_deviation));
      data.datasets[0].label = label;
      chart.options.plugins.title.text = label;
      data.datasets[0].data = values;
      data.datasets[1].data = values.map((v, i) => v + numStd * stds[i]);
      data.datasets[2].data = values.map((v, i) => v - numStd * stds[i]);
      chart.update();
    }

    async function fetchFrame() {
      const res = await fetch('/frame?' + Date.now(), {cache: 'no-store'});
      if (!res.ok || res.status === 204) return;
      const blob = await res.blob();
      document.getElementById('latestFrame').src = URL.createObjectURL(blob);
    }

    chart.canvas.addEventListener('mousemove', async (evt) => {
      const points = chart.getElementsAtEventForMode(evt, 'nearest', {intersect: true}, true);
      if (points.length) {
        const idx = points[0].index;
        const ts = data.labels[idx];
        if (hoverTs === ts) return;
        hoverTs = ts;
        const res = await fetch(`/frames/${ts}`);
        if (!res.ok) return;
        const json = await res.json();
        frameWindow.innerHTML = '';
        json.frames.filter(f => f.index !== 1).forEach(f => {
          const img = document.createElement('img');
          img.src = `/frames/${ts}/${f.index}`;
          img.className = 'img-fluid mb-2';
          frameWindow.appendChild(img);
        });
      }
    });

    fetchMetrics();
    fetchFrame();
    setInterval(fetchMetrics, 5000);
    setInterval(fetchFrame, 5000);
    </script>
  </body>
</html>
